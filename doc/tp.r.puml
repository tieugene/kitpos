@startuml

header TerminalProxy
title Receipt
caption (item: TicketItem, need_device: bool)

start

if (TicketItem.Status in {0, 5}) then (no)
	:return ResultItem(Code = -1);
	stop
endif
:retCode = -1
fItem = null
rsp = Cmd.ReceiptStart();
if (rsp.result?) then (err)
	:return ResultItem(
		Code = rsp.err_core,
		Result = fItem);
	stop
endif
:TLVPostion = 0
TLV += (1059, (
    (1030, "Услуга пассажирские перевозки"),
    (1079, item.Price),
    (1023, 1),
    (1199, "\1\0\item.Vat"),
    (1214, "\1\0\4"),
    (1212, "\1\0\4")));
note right: 1214=\n1212=\n'l=1,v=4'
:rsp = Cmd.ReceiptPosition(TLV.Take(TLVPostion), item.id);
if (rsp.result?) then (err)
	:return ResultItem(
		Code = rsp.err_core,
		Result = fItem);
	stop
endif
if (need_device) then (ok)
	:rsp = Cmd.ReceiptSendAutoDevice(...);
	note right: Hardcoded:\n1009='',\n1187='',\n1036='1'
endif
if (rsp.result?) then (err)
	:return ResultItem(
		Code = rsp.err_core,
		Result = fItem);
	stop
endif
if (item.PaymentType in {1, 2}) then (no)
	:return ResultItem(
		Code = retCode,
		Result = fItem);
	stop
endif
:TLVPosition = 0
TLV += (1055: item.Tax)
TLV += (1031: cash)
TLV += (1081: cashless);
if (item.Status == 5) then (ok)
	:TLV += (1192: item.fiscalSign);
endif
:TLV += (1215, 0)
TLV += (1216, 0)
TLV += (1217, 0);
:rsp = Cmd.SendPaymentData(TLV.Take(TLVPosition), item.Id);
if (rsp.result?) then (err)
	:return ResultItem(
		Code = rsp.err_core,
		Result = fItem);
	stop
endif
:data = prepared item.Price;
:rsp = Cmd.MakeReceipt(data, item.id);
if (rsp.result) then (err)
	:Cmd.CancelDocument();
	:return ResultItem(
		Code = retCode,
		Result = fItem);
	stop
endif
:fItem = ParseReceiptResponse(rsp)
fItem.ReceiptType = (item.Status == 5 ? 4 : 1)
retCode = 0;
if (fItem) then (!null)
	:fItem.TicketId = item.Id
	fItem.FiscalStatus = (item.Status == 0 ? 2 : 4)
	fItem.Ms = <time cutoff>;
endif
:return ResultItem(Code = retCode, Result = fItem);

stop

@enduml
